<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>حاسبة الخزائن والحلق السفلي — نهائية</title>
<style>
body{font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;background:#f3f4f6;margin:0;padding:18px;}
.container{max-width:1200px;margin:0 auto;background:white;padding:20px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.08);}
h1{text-align:center;color:#0b5ed7}
.panel-row{display:flex;gap:18px;flex-wrap:wrap;margin-bottom:12px}
.card{flex:1 1 320px;background:#fbfdff;border:1px solid #e6eefc;padding:14px;border-radius:10px;}
label{display:block;margin-top:8px;font-weight:600}
input[type="number"], select{width:100%;padding:8px;border-radius:6px;border:1px solid #cbd5e1;margin-top:6px}
.small{font-size:13px;color:#555;margin-top:6px}
.btn{display:inline-block;padding:10px 14px;margin-top:12px;border-radius:8px;border:0;cursor:pointer;background:#0b5ed7;color:#fff}
.btn.secondary{background:#0d6efd77}
.btn.danger{background:#e03131}
.divider-row{display:flex;gap:8px;align-items:center;margin-top:8px}
.divider-row input, .divider-row select{width:48%}
.results{margin-top:20px}
.result-item{background:#f8fafc;border:1px solid #e6eefc;padding:12px;border-radius:8px;margin-bottom:12px}
.error{color:#b91c1c;font-weight:700}
.muted{color:#475569;font-size:14px}
.inline{display:inline-block;margin-left:8px}
.remove-small{background:#ef4444;color:#fff;border:0;padding:6px 8px;border-radius:6px;cursor:pointer}
</style>
</head>
<body>
<div class="container">
<h1>حاسبة الخزائن والحلق السفلي</h1>

<div class="panel-row">
  <div class="card" id="cabinetsPanel">
    <h3>الخزائن</h3>
    <div id="cabinetsContainer"></div>
    <button class="btn" id="addCabinetBtn">➕ إضافة خزانة جديدة</button>
    <p class="small muted">كل خزانة: أدخل العرض والارتفاع والعمق وعدد الأبواب. الحساب ينقص 5 سم لكل بروفيل.</p>
  </div>

  <div class="card" id="basesPanel">
    <h3>الحلقات السفلي</h3>
    <div id="basesContainer"></div>
    <button class="btn" id="addBaseBtn">➕ إضافة حلق سفلي جديد</button>
    <p class="small muted">لكل حلق: أدخل العرض والارتفاع، أضف قواطع، وحدد عدد أبواب الجزء النهائي.</p>
  </div>
</div>

<div style="text-align:center">
  <button class="btn" id="calculateBtn">📊 حساب النتائج النهائية</button>
</div>

<div class="results" id="results"></div>
</div>

<script>
const PROFILE_WIDTH = 5;
const CUTTER_WIDTH = 5;

let cabinetCount = 0;
let baseCount = 0;

document.getElementById('addCabinetBtn').addEventListener('click', () => {
  cabinetCount++;
  const cont = document.getElementById('cabinetsContainer');
  const wrapper = document.createElement('div');
  wrapper.className = 'element-container';
  wrapper.id = `cabinet${cabinetCount}`;
  wrapper.style.marginBottom = '12px';
  wrapper.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>خزانة ${cabinetCount}</strong>
      <button class="remove-small" onclick="removeCabinet(${cabinetCount})">حذف</button>
    </div>
    <label>عرض الخزانة (سم)</label>
    <input type="number" class="cabWidth" placeholder="مثال: 120">
    <label>ارتفاع الخزانة (سم)</label>
    <input type="number" class="cabHeight" placeholder="مثال: 80">
    <label>عمق الخزانة (سم)</label>
    <input type="number" class="cabDepth" placeholder="مثال: 60">
    <label>عدد الأبواب</label>
    <select class="cabDoors">
      <option value="1">باب واحد</option>
      <option value="2">بابان</option>
    </select>
  `;
  cont.appendChild(wrapper);
});

document.getElementById('addBaseBtn').addEventListener('click', () => {
  baseCount++;
  const cont = document.getElementById('basesContainer');
  const wrapper = document.createElement('div');
  wrapper.className = 'element-container';
  wrapper.id = `base${baseCount}`;
  wrapper.style.marginBottom = '12px';
  wrapper.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>الحلق السفلي ${baseCount}</strong>
      <button class="remove-small" onclick="removeBase(${baseCount})">حذف</button>
    </div>
    <label>عرض الحلق (سم)</label>
    <input type="number" class="baseWidth" placeholder="مثال: 240">
    <label>ارتفاع الحلق (سم)</label>
    <input type="number" class="baseHeight" placeholder="مثال: 50">
    <div class="dividersContainer"></div>
    <button type="button" class="btn secondary" style="margin-top:10px" onclick="addDivider(${baseCount})">➕ إضافة قاطع</button>
    <label style="margin-top:8px">عدد أبواب الجزء النهائي</label>
    <select class="baseDoors">
      <option value="1">باب واحد</option>
      <option value="2">بابان</option>
    </select>
  `;
  cont.appendChild(wrapper);
});

function removeCabinet(id){ const el=document.getElementById('cabinet'+id); if(el) el.remove();}
function removeBase(id){ const el=document.getElementById('base'+id); if(el) el.remove();}

function addDivider(baseId){
  const baseDiv = document.getElementById('base'+baseId);
  if(!baseDiv) return;
  const container = baseDiv.querySelector('.dividersContainer');
  const idx = container.children.length + 1;
  const row = document.createElement('div');
  row.className = 'divider-row';
  row.dataset.index = idx;
  row.innerHTML = `
    <input type="number" class="dividerInput" placeholder="مسافة القاطع ${idx} (سم) من البداية/القاطع السابق">
    <select class="dividerDoors">
      <option value="1">عدد أبواب الجزء السابق: 1</option>
      <option value="2">عدد أبواب الجزء السابق: 2</option>
    </select>
    <button class="remove-small" style="height:36px" onclick="this.parentElement.remove()">×</button>
  `;
  container.appendChild(row);
}

document.getElementById('calculateBtn').addEventListener('click', () => {
  const results = document.getElementById('results');
  results.innerHTML = '';

  // خزائن
  const cabinetEls = Array.from(document.querySelectorAll('[id^="cabinet"]'));
  cabinetEls.forEach((cabEl, idx) => {
    const w=parseFloat(cabEl.querySelector('.cabWidth')?.value) || 0;
    const h=parseFloat(cabEl.querySelector('.cabHeight')?.value) || 0;
    const d=parseFloat(cabEl.querySelector('.cabDepth')?.value) || 0;
    if(w<=0||h<=0||d<=0) return; // تجاهل الفارغة
    const doors = parseInt(cabEl.querySelector('.cabDoors')?.value) || 1;

    const wAdj = +(w-5).toFixed(2);
    const hAdj = +(h-5).toFixed(2);
    const dAdj = +(d-5).toFixed(2);

    let doorDetails='';
    let totalDoors=0, totalHinges=0, totalHandles=0;
    if(doors===1){
      const doorH=+(hAdj-3).toFixed(2);
      const doorW=+(wAdj-3).toFixed(2);
      totalDoors=1; totalHinges=2; totalHandles=1;
      doorDetails+=`<div>باب واحد — عرض ${doorW} سم × ارتفاع ${doorH} سم — فصالات 2 / يد 1</div>`;
    } else {
      const doorH=+(hAdj-3).toFixed(2);
      const doorW=+(((wAdj-2.5)/2).toFixed(2));
      totalDoors=2; totalHinges=4; totalHandles=2;
      doorDetails+=`<div>بابان — لكل باب عرض ${doorW} سم × ارتفاع ${doorH} سم — فصالات 2 / يد 1</div>`;
    }

    const html=document.createElement('div');
    html.className='result-item';
    html.innerHTML=`
      <strong>خزانة ${idx+1}</strong>
      <div class="muted">الأبعاد الأصلية: عرض ${w} سم × ارتفاع ${h} سم × عمق ${d} سم</div>
      <div class="muted">الأبعاد بعد خصم 5 سم: عرض ${wAdj} سم × ارتفاع ${hAdj} سم × عمق ${dAdj} سم</div>
      <div style="margin-top:8px"><strong>تفاصيل الأبواب:</strong></div>
      ${doorDetails}
      <div style="margin-top:8px" class="muted">مجموع الأيدي: ${totalHandles} — مجموع الفصالات: ${totalHinges}</div>
    `;
    results.appendChild(html);
  });

  // حلقات
  const baseEls = Array.from(document.querySelectorAll('[id^="base"]'));
  baseEls.forEach((baseEl, idx) => {
    const wRaw=parseFloat(baseEl.querySelector('.baseWidth')?.value)||0;
    const hRaw=parseFloat(baseEl.querySelector('.baseHeight')?.value)||0;
    if(wRaw<=0||hRaw<=0) return;
    const finalDoors=parseInt(baseEl.querySelector('.baseDoors')?.value)||1;

    const divRows=Array.from(baseEl.querySelectorAll('.dividersContainer .divider-row'));
    const N=divRows.length;
    const innerAvailable=+(wRaw-2*PROFILE_WIDTH-N*CUTTER_WIDTH).toFixed(6);
    const distances=divRows.map(r=>parseFloat(r.querySelector('.dividerInput')?.value)||0);
    const distancesSum=distances.reduce((a,b)=>a+b,0);

    const resultCard=document.createElement('div');
    resultCard.className='result-item';
    resultCard.innerHTML=`<strong>الحلق السفلي ${idx+1}</strong>
      <div class="muted">الأبعاد: عرض ${wRaw} × ارتفاع ${hRaw}</div>`;

    if(distancesSum>innerAvailable+1e-9){
      resultCard.innerHTML+=`<div class="error">خطأ: مجموع مسافات القواطع (${distancesSum} سم) أكبر من المساحة الداخلية المتاحة (${innerAvailable} سم)</div>`;
      results.appendChild(resultCard);
      return;
    }

    const remaining=+(innerAvailable-distancesSum).toFixed(6);
    const segments=distances.slice(); segments.push(remaining);

    const doorsPerSegment=[];
    for(let s=0;s<segments.length;s++){
      if(s<divRows.length){
        doorsPerSegment.push(parseInt(divRows[s].querySelector('.dividerDoors')?.value)||1);
      } else { doorsPerSegment.push(finalDoors); }
    }

    let totalDoors=0, totalHinges=0, totalHandles=0;
    resultCard.innerHTML+=`<div style="margin-top:8px"><strong>تفاصيل المقاطع:</strong></div>`;
    segments.forEach((segWidth,segIdx)=>{
      const doorsCount=doorsPerSegment[segIdx];
      const doorHeight=+(hRaw-3).toFixed(2);
      if(doorsCount===1){
        const doorW=+(segWidth-3).toFixed(2);
        resultCard.innerHTML+=`<div>المقطع ${segIdx+1}: باب واحد: عرض ${doorW} × ارتفاع ${doorHeight} — فصالات 2 / يد 1</div>`;
        totalDoors+=1; totalHinges+=2; totalHandles+=1;
      } else {
        const perDoorW=+((segWidth-2.5)/2).toFixed(2);
        resultCard.innerHTML+=`<div>المقطع ${segIdx+1}: بابان لكل باب ${perDoorW} × ${doorHeight} — فصالات 2 / يد 1</div>`;
        totalDoors+=2; totalHinges+=4; totalHandles+=2;
      }
    });
    resultCard.innerHTML+=`<div style="margin-top:8px" class="muted">ملخص الحلق ${idx+1}: مجموع الأبواب: ${totalDoors} — مجموع الفصالات: ${totalHinges} — مجموع الأيدي: ${totalHandles}</div>`;
    results.appendChild(resultCard);
  });
});
</script>
</body>
</html>
